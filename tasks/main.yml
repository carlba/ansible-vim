---

- name: Get installed neovim version
  shell: "nvim --version | head -n 1"
  register: neovim_version_output
  changed_when: false

- name: Ensure apt cache is updated on Debian based OSes
  become: true
  apt: update_cache=true cache_valid_time=3600
  when: is_privileged_user and ansible_os_family == 'Debian'

- include: ubuntu.yml
  when: is_privileged_user and ansible_distribution in ['Ubuntu']

- include: rhel.yml
  when: is_privileged_user and ansible_os_family in ['RedHat']

- name: Ensure neovim is the latest version
  become: "{{ (ansible_os_family in ['Darwin']) | ternary('false', 'true') }}"
  package: name=neovim state=latest

- name: Install neovim Python library
  become: "{{ (ansible_os_family in ['Darwin']) | ternary('false', 'true') }}"
  pip:
    name: neovim
    executable: pip
    extra_args: --upgrade

- name: Ensure nvim config directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/nvim"
    recurse: true
    state: directory

# TODO: Make this a bit cleaner
- name: Retrieve result of vim-bootstrap post request
  uri:
    url: 'http://vim-bootstrap.com/generate.vim'
    method: POST
    return_content: true
    body_format: form-urlencoded
    body:
      langs: ['javascript', 'php', 'html', 'ruby', 'python']
      editor: nvim
    status_code: 200
  register: uri_result

- name: Ensure output of vim-bootstrap.com generate request is stored to init.vim
  copy:
    content: '{{ uri_result.content }}'
    dest: '{{ ansible_env.HOME }}/.config/nvim/init.vim'

- name: Ensure nvim plugins are installed
  shell: nvim +PlugInstall +qall --headless
  register: nvim_plugins_install_command
  changed_when: nvim_plugins_install_command.stderr != ""
  failed_when: nvim_plugins_install_command.rc !=0 or "Error" in nvim_plugins_install_command.stderr

# nocompatible prevents home and end buttons from inserting H and F characters
- name: Apply customized vim settings
  blockinfile:
    dest: "{{ ansible_env.HOME }}/.config/nvim/local_init.vim"
    create: true
    marker: ' " {mark} ANSIBLE MANAGED BLOCK'
    block: |
      colorscheme zenburn
      set nocompatible
      let g:airline_theme = 'lucius'
      autocmd FileType python setlocal colorcolumn=99
      set guicursor=

- name: Add custom plugins
  blockinfile:
    dest: "{{ ansible_env.HOME }}/.config/nvim/local_bundles.vim"
    create: true
    marker: ' " {mark} ANSIBLE MANAGED BLOCK'
    block: |
      Plug 'vim-scripts/Zenburn'
